<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Фильтр объявлений — Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 18px; max-width: 720px; margin: 0 auto; background:#f7f7fb; color:#111;}
    .card { background:white; border-radius:12px; box-shadow:0 6px 20px rgba(20,20,30,0.06); padding:18px; margin-top:24px;}
    label {display:block; margin:10px 0 4px; font-weight:600; font-size:14px;}
    input, select {width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6e6ef; font-size:14px; box-sizing:border-box;}
    .row {display:flex; gap:10px;}
    .row > * {flex:1;}
    .actions {display:flex; gap:10px; margin-top:14px;}
    button {padding:10px 14px; border-radius:10px; border:0; font-weight:600; cursor:pointer;}
    .btn-primary {background:#0064ff; color:white;}
    .btn-ghost {background:transparent; border:1px solid #dfe7ff;}
    .loading {display:none; text-align:center; margin-top:10px; color:#0064ff;}
    small.note {color:#666;display:block;margin-top:10px;}
  </style>
</head>
<body>
  <h2>Фильтр объявлений</h2>
  <div class="card">
    <label>Категория</label>
    <select id="category">
      <option value="">Любая категория</option>
      <option value="авто">Авто</option>
      <option value="недвижимость">Недвижимость</option>
      <option value="электроника">Электроника</option>
      <option value="услуги">Услуги</option>
    </select>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Цена мин</label>
        <input id="price_min" type="number" placeholder="0">
      </div>
      <div>
        <label>Цена макс</label>
        <input id="price_max" type="number" placeholder="100000">
      </div>
    </div>

    <label style="margin-top:8px;">Ключевые слова</label>
    <input id="keywords" placeholder="например: iPhone, ремонт, сад">

    <label style="margin-top:8px;">Город (необязательно)</label>
    <input id="city" placeholder="Москва">

    <div class="actions">
      <button id="apply" class="btn-primary">Применить</button>
      <button id="reset" class="btn-ghost">Сбросить</button>
    </div>

    <div id="loading" class="loading">Отправка данных...</div>
    
    <small class="note">Кнопка "Применить" отправит данные боту и закроет мини‑приложение.</small>
  </div>

  <script>
    const tg = window.Telegram.WebApp;

    // Всегда разворачиваем
    try { tg.expand(); } catch(e){ console.log("Ошибка expand:", e); }

    document.getElementById("apply").addEventListener("click", async () => {
      const loading = document.getElementById('loading');
      loading.style.display = 'block';

      const data = {
        category: document.getElementById("category").value,
        price_min: document.getElementById("price_min").value || null,
        price_max: document.getElementById("price_max").value || null,
        keywords: document.getElementById("keywords").value.trim(),
        city: document.getElementById("city").value.trim(),
        ts: new Date().toISOString()
      };

      const payload = JSON.stringify(data);

      try {
        // answerWebAppQuery
        // tg.initDataUnsafe.query_id приходит, если Mini App открыт через Inline-кнопку
        if (tg.initDataUnsafe && tg.initDataUnsafe.query_id) {
          await fetch(`https://api.telegram.org/bot<YOUR_BOT_TOKEN>/answerWebAppQuery`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              web_app_query_id: tg.initDataUnsafe.query_id,
              result: {
                type: 'article',
                id: 'filters_result_' + Date.now(),
                title: 'Выбранные фильтры',
                input_message_content: {
                  message_text: `✅ Вы выбрали фильтры:\n${payload}`
                }
              }
            })
          });
        } else {
          // fallback для ReplyKeyboardButton (sendData)
          tg.sendData(payload);
        }
      } catch(err){
        console.error("Ошибка отправки:", err);
        alert("Ошибка при отправке данных. Проверьте консоль.");
      }

      // Закрываем мини-приложение
      setTimeout(() => { try { tg.close(); } catch(e){} }, 500);
    });

    document.getElementById("reset").addEventListener("click", () => {
      document.getElementById("category").selectedIndex = 0;
      document.getElementById("price_min").value = "";
      document.getElementById("price_max").value = "";
      document.getElementById("keywords").value = "";
      document.getElementById("city").value = "";
    });
  </script>
</body>
</html>